version: '3.8'

services:
  # 商品服务
  goods-service:
    build:
      context: ./shopping_goods_service
      dockerfile: Dockerfile
    container_name: goods-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - shopping-network

  # 用户服务
  user-service:
    build:
      context: ./shopping_user_service
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - shopping-network

  # 订单服务
  order-service:
    build:
      context: ./shopping_order_service
      dockerfile: Dockerfile
    container_name: order-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - shopping-network

  # 购物车服务
  cart-service:
    build:
      context: ./shopping_cart_service
      dockerfile: Dockerfile
    container_name: cart-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - redis
    networks:
      - shopping-network

  # 支付服务
  pay-service:
    build:
      context: ./shopping_pay_service
      dockerfile: Dockerfile
    container_name: pay-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - shopping-network

  # 秒杀服务
  seckill-service:
    build:
      context: ./shopping_seckill_service
      dockerfile: Dockerfile
    container_name: seckill-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - shopping-network

  # 搜索服务
  search-service:
    build:
      context: ./shopping_search_service
      dockerfile: Dockerfile
    container_name: search-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - elasticsearch
    networks:
      - shopping-network

  # 推荐服务
  recommend-service:
    build:
      context: ./shopping_recommend_service
      dockerfile: Dockerfile
    container_name: recommend-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - redis
    networks:
      - shopping-network

  # 文件服务
  file-service:
    build:
      context: ./shopping_file_service
      dockerfile: Dockerfile
    container_name: file-service
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
    depends_on:
      - nacos
      - fastdfs-tracker
      - fastdfs-storage
    networks:
      - shopping-network

  # 基础设施服务
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: nacos
    environment:
      - MODE=standalone
      - JVM_XMS=256m
      - JVM_XMX=256m
    ports:
      - "8848:8848"
    volumes:
      - /data/nacos/logs:/home/nacos/logs
      - /data/nacos/conf:/home/nacos/conf
    networks:
      - shopping-network

  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=shopping
    ports:
      - "3306:3306"
    volumes:
      - /data/mysql/data:/var/lib/mysql
      - /data/mysql/conf:/etc/mysql/conf.d
      - /data/mysql/logs:/var/log/mysql
    networks:
      - shopping-network

  redis:
    image: redis:6.2
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - /data/redis/data:/data
      - /data/redis/conf:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - shopping-network

  elasticsearch:
    image: elasticsearch:7.17.9
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms256m -Xmx512m"
      - "bootstrap.memory_lock=true"
      - "xpack.security.enabled=false"
    ports:
      - "9200:9200"
    volumes:
      - /data/elasticsearch/data:/usr/share/elasticsearch/data
      - /data/elasticsearch/plugins:/usr/share/elasticsearch/plugins
      - /data/elasticsearch/logs:/usr/share/elasticsearch/logs
    ulimits:
      memlock:
        soft: -1
        hard: -1
    networks:
      - shopping-network
    entrypoint: >
      bash -c "
        if [ ! -d /usr/share/elasticsearch/plugins/analysis-ik ]; then
          echo 'Installing IK plugin...'
          cd /usr/share/elasticsearch/plugins
          unzip elasticsearch-analysis-ik-8.10.4.zip
        fi
        if [ ! -d /usr/share/elasticsearch/plugins/analysis-pinyin ]; then
          echo 'Installing Pinyin plugin...'
          cd /usr/share/elasticsearch/plugins
          unzip elasticsearch-analysis-pinyin-8.10.4.zip
        fi
        /usr/local/bin/docker-entrypoint.sh
      "

  # FastDFS Tracker
  fastdfs-tracker:
    image: delron/fastdfs
    container_name: fastdfs-tracker
    command: tracker
    ports:
      - "22122:22122"
    volumes:
      - /data/fastdfs/tracker:/var/local/fdfs
    networks:
      - shopping-network

  # FastDFS Storage
  fastdfs-storage:
    image: delron/fastdfs
    container_name: fastdfs-storage
    command: storage
    depends_on:
      - fastdfs-tracker
    ports:
      - "8888:8888"
      - "23000:23000"
    volumes:
      - /data/fastdfs/storage:/var/local/fdfs
    environment:
      - TRACKER_SERVER=fastdfs-tracker:22122
    networks:
      - shopping-network

  # Nginx for FastDFS
  fastdfs-nginx:
    image: delron/fastdfs-nginx
    container_name: fastdfs-nginx
    ports:
      - "8889:80"
    volumes:
      - /data/fastdfs/nginx:/etc/nginx/conf.d
    depends_on:
      - fastdfs-storage
    networks:
      - shopping-network

networks:
  shopping-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  es-data:
  minio-data: 