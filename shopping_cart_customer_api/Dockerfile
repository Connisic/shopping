# å¤šé˜¶æ®µæ„å»?- ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®?
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# é¦–å…ˆå¤åˆ¶pomæ–‡ä»¶è¿›è¡Œä¾èµ–ç¼“å­˜
COPY ./pom.xml /build/
COPY ./shopping_common/pom.xml /build/shopping_common/
COPY ./shopping_cart_customer_api/pom.xml /build/shopping_cart_customer_api/

# å°è¯•è§£æå¹¶ä¸‹è½½ä¾èµ–ï¼ˆå¦‚æœpomæ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œä¼šä½¿ç”¨ç¼“å­˜ï¼?
RUN mvn dependency:go-offline -B

# å¤åˆ¶é€šç”¨æ¨¡å—æºä»£ç ?
COPY ./shopping_common/src /build/shopping_common/src/

# å¤åˆ¶APIæºä»£ç ?
COPY ./shopping_cart_customer_api/src /build/shopping_cart_customer_api/src/

# æ„å»ºåº”ç”¨ï¼Œè·³è¿‡æµ‹è¯?
RUN mvn clean package -DskipTests -pl shopping_cart_customer_api -am

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®?- ä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒ
FROM eclipse-temurin:17-jre-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# æ·»åŠ æ ‡ç­¾
LABEL maintainer="Shopping Team"
LABEL description="Cart Customer API for Shopping Platform"

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# è®¾ç½®JVMè¿è¡Œå‚æ•°ï¼Œé™åˆ¶å†…å­˜ä½¿ç”?
ENV JAVA_OPTS="-server -Xms96m -Xmx192m -XX"

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

# å®‰è£…åŸºæœ¬å·¥å…·ï¼ˆå¯é€‰ï¼Œå¦‚éœ€æ›´å°é•œåƒå¯ä»¥ç§»é™¤ï¼?
RUN apk add --no-cache tzdata curl && \
    cp /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    apk del tzdata

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶JARåŒ?
COPY --from=builder /build/shopping_cart_customer_api/target/*.jar /app/app.jar

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²æœåŠ¡ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ?
HEALTHCHECK --interval=30s --timeout=3s CMD curl -f http://localhost:8080/actuator/health || exit 1

# è®¾ç½®å…¥å£ç‚?
ENTRYPOINT ["sh", "-c", "java $-server -Xms96m -Xmx192m -XX -jar app.jar"]
